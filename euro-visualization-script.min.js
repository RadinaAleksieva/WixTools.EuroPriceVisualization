var RATE_BGN = 0.511292;
var REGEX = /(?:€|EUR)(?:\s*|&nbsp;|\u00A0)?(\d+(?:[.,]\d{0,2})?)|(\d+(?:[.,]\d{0,2})?)|(\d(?: ['\u00A0,&nbsp;]\d)*(?:[.,]\d{2}))(?:\s*|&nbsp;|\u00A0)?(?:€|EUR)/g;
var DIGIT_REGEX = /^\d+(?:[.,]\d+)?$/;

function getMatches(text) {
  var matches = [];
  var m;
  while ((m = REGEX.exec(text)) !== null) {
    matches.push(m);
    if (m.index === REGEX.lastIndex) {
      REGEX.lastIndex++;
    }
  }
  REGEX.lastIndex = 0;
  return matches;
}

function convertPriceText(text, roundResult) {
  var matches = getMatches(text);
  if (!matches || matches.length === 0) return;
  var n = null;
  if (matches.length === 1) {
    matches[0][0] && matches[0][0].match(DIGIT_REGEX) && (n = matches[0][0]);
    matches[0][1] && matches[0][1].match(DIGIT_REGEX) && (n = matches[0][1]);
    matches[0][2] && matches[0][2].match(DIGIT_REGEX) && (n = matches[0][2]);
  } else {
    matches[0][0] && matches[0][0].match(DIGIT_REGEX) &&
    matches[1][0] && matches[1][0].match(DIGIT_REGEX)
      ? (n = matches[0][0] + matches[1][0])
      : matches[0][1] && matches[1][0] && matches[1][0].match(DIGIT_REGEX) &&
        (n = matches[0][1].replace(",", "").replace(" ", "") + matches[1][0]);
  }
  if (!n) return;
  var r = parseFloat(n.replace(",", "."));
  if (isNaN(r)) return;
  return roundResult
    ? (r / RATE_BGN).toFixed(0)
    : (r / RATE_BGN).toFixed(2).replace(".", ",");
}

function appendBGN(el, value, color, fontSize) {
  if (el.querySelector(".bgn-price") || el.innerHTML.indexOf("лв") !== -1) return;
  var span = document.createElement("span");
  span.className = "bgn-price";
  span.textContent = "/ " + value + " лв";
  var computed = "";
  if (!color || color === "transparent" || color === "rgba(0, 0, 0, 0)") {
    computed = window.getComputedStyle(el).color;
  }
  span.style.cssText =
    "font-size: " + (fontSize || window.getComputedStyle(el).fontSize || "1em") + ";" +
    "color: " + (color || computed || "inherit") + ";" +
    "margin-left: 6px;" +
    "white-space: nowrap;";
  el.appendChild(span);
}

function forEachNode(selector, fn) {
  var nodes = document.querySelectorAll(selector);
  for (var i = 0; i < nodes.length; i++) {
    fn(nodes[i]);
  }
}

function NotIncludesEuro(el) {
  var text = el.innerText || "";
  return text.indexOf("€") === -1 &&
    text.indexOf("EUR") !== 0 &&
    text.lastIndexOf("EUR") !== text.length - 3;
}

function convertWithInnerText(selectors, roundResult) {
  selectors.forEach(function (selector) {
    forEachNode(selector, function (el) {
      if (el.getAttribute("data-bgn-converted") === "true") return;
      if (NotIncludesEuro(el)) return;
      if (el.innerText.indexOf("лв") !== -1) return;
      if (el.innerHTML.indexOf("лв") !== -1) return;
      var converted = convertPriceText(el.innerText, roundResult);
      if (converted) {
        el.innerText = el.innerText + "/ " + converted + " лв";
        el.setAttribute("data-bgn-converted", "true");
      }
    });
  });
}

function convertWithAppending(selectors) {
  selectors.forEach(function (selector) {
    forEachNode(selector, function (el) {
      if (el.getAttribute("data-bgn-converted") === "true") return;
      if (NotIncludesEuro(el)) return;
      if (el.querySelector(".bgn-price")) return;
      if (el.innerHTML.indexOf("лв") !== -1) return;
      var converted = convertPriceText(el.innerText);
      if (converted) {
        appendBGN(el, converted, el.style.color, el.style.fontSize);
        el.setAttribute("data-bgn-converted", "true");
      }
    });
  });
}

function convertCategoryPrices() {
  convertWithAppending([
    '[data-hook="product-item-price-to-pay"]',
    '[data-hook="formatted-primary-price"]',
    '[data-hook="challenge-pricing"]'
  ]);
}

function convertProductPagePrice() {
  forEachNode('div[data-testid="richTextElement"]', function (el) {
    var target = el.querySelector("p, h2, span, div");
    if (!target || NotIncludesEuro(target) || target.querySelector(".bgn-price") ||
      target.innerHTML.indexOf("лв") !== -1) return;
    var converted = convertPriceText(target.innerText);
    if (converted) appendBGN(target, converted);
  });
}

function convertCartTotals() {
  convertWithAppending([
    '[data-hook="SubTotals.subtotalText"]',
    '[data-hook="SubTotals.Value"]',
    '[data-hook="Total.formattedValue"]',
    '[data-hook="Total.Value"]',
    '[data-hook="TotalShipping.estimatedShipping"]',
    '[data-hook="TotalShipping.Value"]',
    'dd[data-hook="SubTotals.subtotalText"]',
    'dd[data-hook="SubTotals.Value"]',
    'dd[data-hook="Total.formattedValue"]',
    'dd[data-hook="Total.Value"]',
    'dd[data-hook="TotalShipping.estimatedShipping"]',
    'dd[data-hook="TotalShipping.Value"]'
  ]);
}

function convertCheckout() {
  convertWithAppending([
    '[data-hook="total-row-value"] span',
    '[data-hook="total-row-value"]',
    '[data-hook="LineItemDataHooks.Price"]',
    '[data-hook="FoldableSummarySectionDataHook.total"]'
  ]);
}

function convertSideCartPrices() {
  convertWithAppending([
    '[data-hook="CartItemDataHook.price"]',
    '[data-hook="CartItemDataHook.totalPrice"]',
    '[data-hook="Footer.subtotalValue"]',
    '[data-hook="cart-widget-item-price"]',
    '[data-hook="cart-widget-total"]'
  ]);
}

function convertSideCartTotalFallback() {
  var nodes = document.querySelectorAll("h1,h2,h3,h4,h5,h6,span,div");
  for (var i = 0; i < nodes.length; i++) {
    var text = (nodes[i].textContent || "").trim();
    if (text !== "Очаквана обща стойност") continue;
    var sib = nodes[i].nextElementSibling;
    var steps = 0;
    while (sib && steps < 4) {
      if (!sib.getAttribute("data-bgn-converted") &&
        sib.textContent && sib.textContent.indexOf("€") !== -1 &&
        sib.textContent.indexOf("лв") === -1) {
        var converted = convertPriceText(sib.textContent);
        if (converted) {
          appendBGN(sib, converted, sib.style.color, sib.style.fontSize);
          sib.setAttribute("data-bgn-converted", "true");
        }
        break;
      }
      sib = sib.nextElementSibling;
      steps++;
    }
  }
}

function convertCheckoutSummaryPrices() {
  convertWithInnerText([
    '[data-hook="payment-checkout-summary-plan-price"]'
  ]);
}

function convertThankYouPrices() {
  convertWithInnerText([
    '[data-hook="ProductLineItemDataHook.totalPrice"]',
    '[data-hook="subtotal-row-value"]',
    '[data-hook="challenge-pricing"]'
  ]);
}

function convertFilter() {
  convertWithInnerText([
    '[data-hook="filter-type-PRICE"] span'
  ], true);
  forEachNode('[data-hook="filter-type-PRICE"] span', function (el) {
    el.style.fontSize = "17px";
  });
}

function convertShipping() {
  convertWithAppending([
    '[data-hook="dropdown-option"]',
    '[data-hook="dropdown-base-text"]'
  ]);
}

function convertMembers() {
  convertWithInnerText([
    '[data-hook="subtotal"]',
    '[data-hook="shipping"]',
    '[data-hook="tax-0"]',
    '[data-hook="total"]',
    '[data-hook="product-total"]',
    '[data-hook="product-price"]',
    '[data-hook="value"]'
  ]);
}

function convertAllPrices() {
  convertCategoryPrices();
  convertProductPagePrice();
  convertCartTotals();
  convertSideCartPrices();
  convertSideCartTotalFallback();
  convertCheckoutSummaryPrices();
  convertThankYouPrices();
  convertFilter();
  convertCheckout();
}

window.addEventListener("load", function () {
  function removeNode(node) {
    if (!node) return;
    if (typeof node.remove === "function") {
      node.remove();
    } else if (node.parentNode) {
      node.parentNode.removeChild(node);
    }
  }

  function attachCheckoutListener() {
    var button = document.querySelector('[data-hook="place-order-button"]');
    if (!button) return;
    if (button.dataset.listenerAttached) return;
    button.dataset.listenerAttached = "true";
    button.addEventListener("click", function () {
      if (!window.matchMedia("(max-width: 768px)").matches) return;
      var nodes = document.querySelectorAll(".bgn-price");
      for (var i = 0; i < nodes.length; i++) {
        removeNode(nodes[i]);
      }
    });
  }

  setTimeout(function () {
    setInterval(function () {
      convertAllPrices();
    }, 200);
  }, 150);

  setTimeout(function () {
    setInterval(function () {
      attachCheckoutListener();
    }, 1200);
  }, 1500);

  new MutationObserver(attachCheckoutListener).observe(document.body, {
    childList: true,
    subtree: true
  });

  attachCheckoutListener();
});
